using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using HarmonyLib;
using RimWorld;
using UnityEngine;
using Verse;

namespace FactionGearCustomizer
{
    public class FactionGearCustomizerMod : Mod
    {
        public static FactionGearCustomizerSettings Settings;

        public FactionGearCustomizerMod(ModContentPack content) : base(content)
        {
            Settings = GetSettings<FactionGearCustomizerSettings>();
            Log.Message("[FactionGearCustomizer] Loading success!");
            var harmony = new Harmony("yancy.factiongearcustomizer");
            harmony.PatchAll();
        }

        public override string SettingsCategory() => "Faction Gear Customizer";

        public override void DoSettingsWindowContents(UnityEngine.Rect inRect)
        {
            base.DoSettingsWindowContents(inRect);
            FactionGearEditor.DrawEditor(inRect);
        }
    }

    public class FactionGearCustomizerSettings : ModSettings
    {
        public Dictionary<string, FactionGearData> factionGearData = new Dictionary<string, FactionGearData>();

        public override void ExposeData()
        {
            base.ExposeData();
            Scribe_Collections.Look(ref factionGearData, "factionGearData", LookMode.Value, LookMode.Deep);
            if (factionGearData == null)
                factionGearData = new Dictionary<string, FactionGearData>();
        }

        public void ResetToDefault()
        {
            factionGearData.Clear();
            Write();
        }

        public FactionGearData GetOrCreateFactionData(string factionDefName)
        {
            if (!factionGearData.TryGetValue(factionDefName, out var data))
            {
                data = new FactionGearData(factionDefName);
                factionGearData[factionDefName] = data;
            }
            return data;
        }
    }

    public class FactionGearData : IExposable
    {
        public string factionDefName;
        public Dictionary<string, KindGearData> kindGearData = new Dictionary<string, KindGearData>();

        public FactionGearData() { }

        public FactionGearData(string factionDefName)
        {
            this.factionDefName = factionDefName;
        }

        public void ExposeData()
        {
            Scribe_Values.Look(ref factionDefName, "factionDefName");
            Scribe_Collections.Look(ref kindGearData, "kindGearData", LookMode.Value, LookMode.Deep);
            if (kindGearData == null)
                kindGearData = new Dictionary<string, KindGearData>();
        }

        public KindGearData GetOrCreateKindData(string kindDefName)
        {
            if (!kindGearData.TryGetValue(kindDefName, out var data))
            {
                data = new KindGearData(kindDefName);
                kindGearData[kindDefName] = data;
            }
            return data;
        }

        public void ResetToDefault()
        {
            kindGearData.Clear();
        }
    }

    public class KindGearData : IExposable
    {
        public string kindDefName;
        public List<GearItem> weapons = new List<GearItem>();
        public List<GearItem> meleeWeapons = new List<GearItem>();
        public List<GearItem> armors = new List<GearItem>();
        public List<GearItem> apparel = new List<GearItem>();
        public List<GearItem> accessories = new List<GearItem>();

        public KindGearData() { }

        public KindGearData(string kindDefName)
        {
            this.kindDefName = kindDefName;
        }

        public void ExposeData()
        {
            Scribe_Values.Look(ref kindDefName, "kindDefName");
            Scribe_Collections.Look(ref weapons, "weapons", LookMode.Deep);
            Scribe_Collections.Look(ref meleeWeapons, "meleeWeapons", LookMode.Deep);
            Scribe_Collections.Look(ref armors, "armors", LookMode.Deep);
            Scribe_Collections.Look(ref apparel, "apparel", LookMode.Deep);
            Scribe_Collections.Look(ref accessories, "accessories", LookMode.Deep);

            if (weapons == null) weapons = new List<GearItem>();
            if (meleeWeapons == null) meleeWeapons = new List<GearItem>();
            if (armors == null) armors = new List<GearItem>();
            if (apparel == null) apparel = new List<GearItem>();
            if (accessories == null) accessories = new List<GearItem>();
        }

        public void ResetToDefault()
        {
            weapons.Clear();
            meleeWeapons.Clear();
            armors.Clear();
            apparel.Clear();
            accessories.Clear();
        }
    }

    public class GearItem : IExposable
    {
        public string thingDefName;
        public float weight = 1f;

        public GearItem() { }

        public GearItem(string thingDefName, float weight = 1f)
        {
            this.thingDefName = thingDefName;
            this.weight = weight;
        }

        public void ExposeData()
        {
            Scribe_Values.Look(ref thingDefName, "thingDefName");
            Scribe_Values.Look(ref weight, "weight", 1f);
        }

        public ThingDef ThingDef => DefDatabase<ThingDef>.GetNamedSilentFail(thingDefName);
    }

    // [修复] 类名从 FactionGearCustomizer 改为 FactionGearManager，解决调用错误
    public static class FactionGearManager
    {
        public static void LoadDefaultPresets()
        {
            foreach (var factionDef in DefDatabase<FactionDef>.AllDefs)
            {
                var factionData = FactionGearCustomizerMod.Settings.GetOrCreateFactionData(factionDef.defName);
                if (factionDef.pawnGroupMakers != null)
                {
                    foreach (var pawnGroupMaker in factionDef.pawnGroupMakers)
                    {
                        if (pawnGroupMaker.options != null)
                        {
                            foreach (var option in pawnGroupMaker.options)
                            {
                                if (option.kind != null) // [修复] 错误位置：178行，错误内容：PawnGenOption未包含kindDef的定义
                                {
                                    var kindData = factionData.GetOrCreateKindData(option.kind.defName); // [修复] 错误位置：180行，错误内容：PawnGenOption未包含kindDef的定义
                                    LoadKindDefGear(option.kind, kindData); // [修复] 错误位置：181行，错误内容：PawnGenOption未包含kindDef的定义
                                }
                            }
                        }
                    }
                }
            }
        }

        // [修复] 将 LoadKindDefGear 改为 public，供重置单兵种时重新抓取数据使用
        public static void LoadKindDefGear(PawnKindDef kindDef, KindGearData kindData)
        {
            if (kindDef.weaponTags != null)
            {
                foreach (var tag in kindDef.weaponTags)
                {
                    var weapons = DefDatabase<ThingDef>.AllDefs.Where(t => t.IsWeapon && t.weaponTags != null && t.weaponTags.Contains(tag)).ToList();
                    foreach (var weapon in weapons)
                    {
                        if (weapon.IsRangedWeapon)
                        {
                            if (!kindData.weapons.Any(g => g.thingDefName == weapon.defName))
                                kindData.weapons.Add(new GearItem(weapon.defName));
                        }
                        else
                        {
                            if (!kindData.meleeWeapons.Any(g => g.thingDefName == weapon.defName))
                                kindData.meleeWeapons.Add(new GearItem(weapon.defName));
                        }
                    }
                }
            }

            // [修复] 错误位置：214行，错误内容：PawnKindDef未包含apparelRequirements的定义
            // 改为加载默认装备
            LoadDefaultApparel(kindData);
        }

        // [修复] 添加加载默认装备的方法
        private static void LoadDefaultApparel(KindGearData kindData)
        {
            // 加载默认装甲
            var armors = DefDatabase<ThingDef>.AllDefs.Where(t => t.IsApparel && t.apparel.bodyPartGroups.Contains(BodyPartGroupDefOf.Torso)).Take(5).ToList();
            foreach (var armor in armors)
            {
                if (!kindData.armors.Any(g => g.thingDefName == armor.defName))
                    kindData.armors.Add(new GearItem(armor.defName));
            }

            // 加载默认衣服
            var apparels = DefDatabase<ThingDef>.AllDefs.Where(t => t.IsApparel && !t.apparel.bodyPartGroups.Contains(BodyPartGroupDefOf.Torso) && 
                (t.apparel.layers.Contains(ApparelLayerDefOf.OnSkin) || t.apparel.layers.Contains(ApparelLayerDefOf.Middle))).Take(5).ToList();
            foreach (var apparel in apparels)
            {
                if (!kindData.apparel.Any(g => g.thingDefName == apparel.defName))
                    kindData.apparel.Add(new GearItem(apparel.defName));
            }

            // [修复] 错误位置：231行和249行，错误内容：ApparelLayerDefOf未包含Neck的定义
            // 加载默认饰品（只包含腰带）
            var accessories = DefDatabase<ThingDef>.AllDefs.Where(t => t.IsApparel && t.apparel.layers.Contains(ApparelLayerDefOf.Belt)).Take(5).ToList();
            foreach (var accessory in accessories)
            {
                if (!kindData.accessories.Any(g => g.thingDefName == accessory.defName))
                    kindData.accessories.Add(new GearItem(accessory.defName));
            }
        }

        public static List<ThingDef> GetAllWeapons() => DefDatabase<ThingDef>.AllDefs.Where(t => t.IsRangedWeapon).ToList();
        public static List<ThingDef> GetAllMeleeWeapons() => DefDatabase<ThingDef>.AllDefs.Where(t => t.IsMeleeWeapon).ToList();
        public static List<ThingDef> GetAllArmors() => DefDatabase<ThingDef>.AllDefs.Where(t => t.IsApparel && t.apparel.bodyPartGroups.Contains(BodyPartGroupDefOf.Torso)).ToList();
        
        public static List<ThingDef> GetAllApparel() => DefDatabase<ThingDef>.AllDefs.Where(t => t.IsApparel && !t.apparel.bodyPartGroups.Contains(BodyPartGroupDefOf.Torso) && 
                (t.apparel.layers.Contains(ApparelLayerDefOf.OnSkin) || t.apparel.layers.Contains(ApparelLayerDefOf.Middle))).ToList();
                
        // [修复] 错误位置：249行，错误内容：ApparelLayerDefOf未包含Neck的定义
        public static List<ThingDef> GetAllAccessories() => DefDatabase<ThingDef>.AllDefs.Where(t => t.IsApparel && t.apparel.layers.Contains(ApparelLayerDefOf.Belt)).ToList();

       public static float GetWeaponRange(ThingDef weaponDef)
        {
            // [修复] 注意首字母大写的 Verbs
            if (weaponDef.Verbs != null && weaponDef.Verbs.Count > 0)
            {
                return weaponDef.Verbs[0].range;
            }
            return 0f;
        }

      public static float GetWeaponDamage(ThingDef weaponDef)
        {
            float maxDamage = 0f;

            // 1. 读取远程武器的子弹伤害
            if (weaponDef.IsRangedWeapon && weaponDef.Verbs != null && weaponDef.Verbs.Count > 0)
            {
                var projectileDef = weaponDef.Verbs[0].defaultProjectile;
                if (projectileDef != null && projectileDef.projectile != null)
                {
                    // [修复] 适配 1.5/1.6 版本，使用 GetDamageAmount 方法替代已经被官方删除的 damageAmountBase 字段
                    // 传入 null 代表获取无品质加成的基础理论伤害
                    maxDamage = projectileDef.projectile.GetDamageAmount(null); 
                }
            }

            // 2. 读取武器的近战伤害 (近战武器，或是远程武器的枪托砸击)
            if (weaponDef.tools != null && weaponDef.tools.Count > 0)
            {
                float meleeDamage = weaponDef.tools.Max(tool => tool.power);
                if (meleeDamage > maxDamage)
                {
                    maxDamage = meleeDamage;
                }
            }

            return maxDamage;
        }

        public static TechLevel GetTechLevel(ThingDef thingDef) => thingDef.techLevel;
        public static string GetModSource(ThingDef thingDef) => thingDef.modContentPack?.Name ?? "Unknown";
    }


    // 恢复最标准的 Harmony 拦截格式，不再使用动态 TargetMethod
    [HarmonyPatch(typeof(PawnGenerator), "GeneratePawn", new Type[] { typeof(PawnGenerationRequest) })]
    public static class Patch_GeneratePawn
    {
        // 移除 request 前面的 ref 关键字
        public static void Postfix(Pawn __result, PawnGenerationRequest request)
        {
            if (__result != null && request.Faction != null && __result.RaceProps != null && __result.RaceProps.Humanlike)
            {
                GearApplier.ApplyCustomGear(__result, request.Faction);
            }
        }
    }

    public static class GearApplier
    {
        public static void ApplyCustomGear(Pawn pawn, Faction faction)
        {
            if (pawn == null || faction == null) return;

            var factionData = FactionGearCustomizerMod.Settings.GetOrCreateFactionData(faction.def.defName);
            var kindDefName = pawn.kindDef?.defName;

            if (!string.IsNullOrEmpty(kindDefName) && factionData.kindGearData.TryGetValue(kindDefName, out var kindData))
            {
                ApplyWeapons(pawn, kindData);
                ApplyApparel(pawn, kindData);
            }
        }

        private static void ApplyWeapons(Pawn pawn, KindGearData kindData)
        {
            pawn.equipment?.DestroyAllEquipment();

            if (kindData.weapons.Any())
            {
                var weaponItem = GetRandomGearItem(kindData.weapons);
                var weaponDef = weaponItem?.ThingDef;
                if (weaponDef != null)
                {
                    // [修复] 添加材料Stuff，防止报错
                    ThingDef stuff = weaponDef.MadeFromStuff ? GenStuff.RandomStuffFor(weaponDef) : null;
                    var weapon = (ThingWithComps)ThingMaker.MakeThing(weaponDef, stuff);
                    
                    // [优化] 添加武器质量（基于派系科技等级生成）
                    CompQuality compQuality = weapon.TryGetComp<CompQuality>();
                    if (compQuality != null)
                    {
                        // [修复] 错误位置：334行，错误内容：参数 1: 无法从“RimWorld.TechLevel”转换为“RimWorld.QualityGenerator”
                        // 简化实现，直接设置为Normal质量
                        compQuality.SetQuality(QualityCategory.Normal, ArtGenerationContext.Outsider);
                    }
                        
                    pawn.equipment?.AddEquipment(weapon);
                }
            }

            if (kindData.meleeWeapons.Any())
            {
                var meleeItem = GetRandomGearItem(kindData.meleeWeapons);
                var meleeDef = meleeItem?.ThingDef;
                if (meleeDef != null)
                {
                    ThingDef stuff = meleeDef.MadeFromStuff ? GenStuff.RandomStuffFor(meleeDef) : null;
                    var meleeWeapon = (ThingWithComps)ThingMaker.MakeThing(meleeDef, stuff);
                    
                    CompQuality compQuality = meleeWeapon.TryGetComp<CompQuality>();
                    if (compQuality != null)
                    {
                        // [修复] 错误位置：351行，错误内容：参数 1: 无法从“RimWorld.TechLevel”转换为“RimWorld.QualityGenerator”
                        // 简化实现，直接设置为Normal质量
                        compQuality.SetQuality(QualityCategory.Normal, ArtGenerationContext.Outsider);
                    }
                        
                    pawn.equipment?.AddEquipment(meleeWeapon);
                }
            }
        }

        private static void ApplyApparel(Pawn pawn, KindGearData kindData)
        {
            foreach (var apparel in pawn.apparel.WornApparel.ToList())
            {
                pawn.apparel.Remove(apparel);
                apparel.Destroy();
            }

            // [优化] 封装衣服生成逻辑，减少重复代码
            void EquipApparelList(List<GearItem> gearList)
            {
                if (!gearList.Any()) return;
                var item = GetRandomGearItem(gearList);
                var def = item?.ThingDef;
                if (def != null)
                {
                    ThingDef stuff = def.MadeFromStuff ? GenStuff.RandomStuffFor(def) : null;
                    var apparel = (Apparel)ThingMaker.MakeThing(def, stuff);
                    
                    CompQuality compQuality = apparel.TryGetComp<CompQuality>();
                    if (compQuality != null)
                    {
                        // [修复] 错误位置：379行，错误内容：参数 1: 无法从“RimWorld.TechLevel”转换为“RimWorld.QualityGenerator”
                        // 简化实现，直接设置为Normal质量
                        compQuality.SetQuality(QualityCategory.Normal, ArtGenerationContext.Outsider);
                    }
                        
                    pawn.apparel.Wear(apparel, false);
                }
            }

            EquipApparelList(kindData.armors);
            EquipApparelList(kindData.apparel);
            EquipApparelList(kindData.accessories);
        }

        private static GearItem GetRandomGearItem(List<GearItem> items)
        {
            if (!items.Any()) return null;

            var totalWeight = items.Sum(item => item.weight);
            var randomValue = Rand.Value * totalWeight;
            var currentWeight = 0f;

            foreach (var item in items)
            {
                currentWeight += item.weight;
                if (randomValue <= currentWeight)
                {
                    return item;
                }
            }

            return items.First();
        }

        // [修复] 移除未使用的方法，所有调用处已改为直接设置QualityCategory.Normal
        // private static QualityGenerator GetQualityGeneratorFromTechLevel(TechLevel techLevel)
        // {
        //     // [修复] 错误位置：415行，错误内容：无法将null转换为QualityGenerator
        //     // 简化实现，直接返回Random
        //     return QualityGenerator.Random;
        // }
    }

    public static class FactionGearEditor
    {
        private static string selectedFactionDefName = "";
        private static string selectedKindDefName = "";
        private static GearCategory selectedCategory = GearCategory.Weapons;
        private static Vector2 factionListScrollPos = Vector2.zero;
        private static Vector2 kindListScrollPos = Vector2.zero;
        private static Vector2 gearListScrollPos = Vector2.zero;
        private static Vector2 libraryScrollPos = Vector2.zero;
        private static string searchText = "";
        
        private static string selectedModSource = "All";
        private static TechLevel? selectedTechLevel = null;
        private static float minRange = 0f;
        private static float maxRange = 100f;
        private static float minDamage = 0f;
        private static float maxDamage = 100f;

        private static Vector2 mainScrollPos = Vector2.zero;
        public static void DrawEditor(UnityEngine.Rect inRect)
        {
            var viewRect = new UnityEngine.Rect(0, 0, inRect.width - 16, inRect.height + 1000);
            var scrollView = new UnityEngine.Rect(0, 0, inRect.width, inRect.height);

            mainScrollPos = UnityEngine.GUI.BeginScrollView(scrollView, mainScrollPos, viewRect);
            UnityEngine.GUI.BeginScrollView(scrollView, Vector2.zero, viewRect);

            var buttonRect = new UnityEngine.Rect(10, 10, 150, 30);

            if (UnityEngine.GUI.Button(buttonRect, "Load Default Presets"))
            {
                FactionGearManager.LoadDefaultPresets();
                FactionGearCustomizerMod.Settings.Write();
            }

            buttonRect.x += 160;
            if (UnityEngine.GUI.Button(buttonRect, "Reset All to Default"))
            {
                FactionGearCustomizerMod.Settings.ResetToDefault();
            }

            if (!string.IsNullOrEmpty(selectedFactionDefName))
            {
                buttonRect.x += 160;
                if (UnityEngine.GUI.Button(buttonRect, "Reset Current Faction"))
                {
                    ResetCurrentFaction();
                }

                if (!string.IsNullOrEmpty(selectedKindDefName))
                {
                    buttonRect.x += 160;
                    if (UnityEngine.GUI.Button(buttonRect, "Reset Current Kind"))
                    {
                        ResetCurrentKind();
                    }
                }
            }

            buttonRect.x += 160;
            if (UnityEngine.GUI.Button(buttonRect, "Reset Filters"))
            {
                ResetFilters();
            }

            var leftPanel = new UnityEngine.Rect(10, 50, 200, viewRect.height - 60);
            var middlePanel = new UnityEngine.Rect(220, 50, 300, viewRect.height - 60);
            var rightPanel = new UnityEngine.Rect(530, 50, 400, viewRect.height - 60);

            DrawLeftPanel(leftPanel);
            DrawMiddlePanel(middlePanel);
            DrawRightPanel(rightPanel);

            UnityEngine.GUI.EndScrollView();
        }

        private static void DrawLeftPanel(UnityEngine.Rect rect)
        {
            var factionRect = new UnityEngine.Rect(rect.x, rect.y, rect.width, rect.height / 2 - 10);
            var kindRect = new UnityEngine.Rect(rect.x, rect.y + rect.height / 2 + 10, rect.width, rect.height / 2 - 10);

            UnityEngine.GUI.Box(factionRect, "Factions");
            var factionListRect = new UnityEngine.Rect(factionRect.x + 5, factionRect.y + 25, factionRect.width - 10, factionRect.height - 30);
            
            // [优化] 动态计算派系列表高度
            float factionHeight = Mathf.Max(DefDatabase<FactionDef>.AllDefs.Count() * 25f, factionListRect.height);
            factionListScrollPos = UnityEngine.GUI.BeginScrollView(factionListRect, factionListScrollPos, new UnityEngine.Rect(0, 0, factionListRect.width - 20, factionHeight));

            float y = 0;
            foreach (var factionDef in DefDatabase<FactionDef>.AllDefs)
            {
                var itemRect = new UnityEngine.Rect(0, y, factionListRect.width - 20, 22);

                if (UnityEngine.GUI.Button(itemRect, factionDef.LabelCap))
                {
                    selectedFactionDefName = factionDef.defName;
                    selectedKindDefName = "";
                }
                if (selectedFactionDefName == factionDef.defName)
                {
                    UnityEngine.GUI.DrawTexture(new UnityEngine.Rect(itemRect.x - 2, itemRect.y, 2, itemRect.height), UnityEngine.Texture2D.whiteTexture);
                }
                y += 25;
            }

            UnityEngine.GUI.EndScrollView();

            UnityEngine.GUI.Box(kindRect, "Kind Defs");
            var kindListRect = new UnityEngine.Rect(kindRect.x + 5, kindRect.y + 25, kindRect.width - 10, kindRect.height - 30);
            
            y = 0;
            List<PawnKindDef> kindDefsToDraw = new List<PawnKindDef>();
            if (!string.IsNullOrEmpty(selectedFactionDefName))
            {
                var factionDef = DefDatabase<FactionDef>.GetNamedSilentFail(selectedFactionDefName);
                if (factionDef != null && factionDef.pawnGroupMakers != null)
                {
                    foreach (var pawnGroupMaker in factionDef.pawnGroupMakers)
                    {
                        if (pawnGroupMaker.options != null)
                        {
                            foreach (var option in pawnGroupMaker.options)
                            {
                                // [修复] 错误位置：532行，错误内容：PawnGenOption未包含kindDef的定义
                                if (option.kind != null && !kindDefsToDraw.Contains(option.kind))
                                {
                                    kindDefsToDraw.Add(option.kind);
                                }
                            }
                        }
                    }
                }
            }
            
            // [优化] 动态计算兵种列表高度
            float kindHeight = Mathf.Max(kindDefsToDraw.Count * 25f, kindListRect.height);
            kindListScrollPos = UnityEngine.GUI.BeginScrollView(kindListRect, kindListScrollPos, new UnityEngine.Rect(0, 0, kindListRect.width - 20, kindHeight));
            
            foreach (var kindDef in kindDefsToDraw)
            {
                var itemRect = new UnityEngine.Rect(0, y, kindListRect.width - 20, 22);
                if (UnityEngine.GUI.Button(itemRect, kindDef.LabelCap))
                {
                    selectedKindDefName = kindDef.defName;
                }
                if (selectedKindDefName == kindDef.defName)
                {
                    UnityEngine.GUI.DrawTexture(new UnityEngine.Rect(itemRect.x - 2, itemRect.y, 2, itemRect.height), UnityEngine.Texture2D.whiteTexture);
                }
                y += 25;
            }

            UnityEngine.GUI.EndScrollView();
        }

        private static void DrawMiddlePanel(UnityEngine.Rect rect)
        {
            UnityEngine.GUI.Box(rect, "Selected Gear");
            var tabRect = new UnityEngine.Rect(rect.x + 5, rect.y + 5, rect.width - 10, 30);
            DrawCategoryTabs(tabRect);

            var gearListRect = new UnityEngine.Rect(rect.x + 5, rect.y + 40, rect.width - 10, rect.height - 50);
            
            List<GearItem> gearItemsToDraw = new List<GearItem>();
            if (!string.IsNullOrEmpty(selectedFactionDefName) && !string.IsNullOrEmpty(selectedKindDefName))
            {
                var factionData = FactionGearCustomizerMod.Settings.GetOrCreateFactionData(selectedFactionDefName);
                var kindData = factionData.GetOrCreateKindData(selectedKindDefName);
                gearItemsToDraw = GetCurrentCategoryGear(kindData);
            }

            // [修复] 将硬编码的1000改为基于列表元素动态计算
            float middleHeight = Mathf.Max(gearItemsToDraw.Count * 45f, gearListRect.height);
            gearListScrollPos = UnityEngine.GUI.BeginScrollView(gearListRect, gearListScrollPos, new UnityEngine.Rect(0, 0, gearListRect.width - 20, middleHeight));

            float y = 0;
            if (gearItemsToDraw.Any())
            {
                var factionData = FactionGearCustomizerMod.Settings.GetOrCreateFactionData(selectedFactionDefName);
                var kindData = factionData.GetOrCreateKindData(selectedKindDefName);
                
                // 为了安全移除列表元素，创建一个浅拷贝进行遍历
                foreach (var gearItem in gearItemsToDraw.ToList())
                {
                    var itemRect = new UnityEngine.Rect(0, y, gearListRect.width - 20, 40);
                    DrawGearItem(itemRect, gearItem, kindData);
                    y += 45;
                }
            }

            UnityEngine.GUI.EndScrollView();
        }

        private static void DrawRightPanel(UnityEngine.Rect rect)
        {
            UnityEngine.GUI.Box(rect, "Item Library");
            var searchRect = new UnityEngine.Rect(rect.x + 5, rect.y + 5, rect.width - 10, 30);
            searchText = UnityEngine.GUI.TextField(searchRect, searchText);

            var filterRect = new UnityEngine.Rect(rect.x + 5, rect.y + 40, rect.width - 10, 80);
            DrawFilters(filterRect);

            var libraryRect = new UnityEngine.Rect(rect.x + 5, rect.y + 130, rect.width - 10, rect.height - 140);
            
            var items = GetFilteredItems();
            
            // [修复] 将硬编码的2000改为基于筛选结果数量动态计算
            float libraryHeight = Mathf.Max(items.Count * 45f, libraryRect.height);
            libraryScrollPos = UnityEngine.GUI.BeginScrollView(libraryRect, libraryScrollPos, new UnityEngine.Rect(0, 0, libraryRect.width - 20, libraryHeight));

            float y = 0;
            foreach (var item in items)
            {
                var itemRect = new UnityEngine.Rect(0, y, libraryRect.width - 20, 40);
                DrawLibraryItem(itemRect, item);
                y += 45;
            }

            UnityEngine.GUI.EndScrollView();
        }

        private static void DrawGearItem(UnityEngine.Rect rect, GearItem gearItem, KindGearData kindData)
        {
            var thingDef = gearItem.ThingDef;
            if (thingDef == null) return;

            var labelRect = new UnityEngine.Rect(rect.x, rect.y, rect.width - 100, rect.height);
            UnityEngine.GUI.Label(labelRect, thingDef.LabelCap);

            var weightRect = new UnityEngine.Rect(rect.x + rect.width - 90, rect.y, 60, rect.height);
            gearItem.weight = UnityEngine.GUI.HorizontalSlider(weightRect, gearItem.weight, 0.1f, 10f);

            var weightLabelRect = new UnityEngine.Rect(rect.x + rect.width - 25, rect.y, 20, rect.height);
            UnityEngine.GUI.Label(weightLabelRect, gearItem.weight.ToString("0.0"));

            var removeRect = new UnityEngine.Rect(rect.x + rect.width - 120, rect.y, 25, rect.height);

            if (UnityEngine.GUI.Button(removeRect, "X"))
            {
                RemoveGearItem(gearItem, kindData);
                FactionGearCustomizerMod.Settings.Write();
            }
        }

        private static void DrawLibraryItem(UnityEngine.Rect rect, ThingDef thingDef)
        {
            var labelRect = new UnityEngine.Rect(rect.x, rect.y, rect.width - 80, 20);
            UnityEngine.GUI.Label(labelRect, thingDef.LabelCap);

            var infoRect = new UnityEngine.Rect(rect.x, rect.y + 20, rect.width - 80, 20);
            string infoText = GetItemInfo(thingDef);
            // [修复] 错误位置：658行，错误内容：GUISkin未包含smallLabel的定义
            UnityEngine.GUI.Label(infoRect, infoText); // 使用默认标签样式

            var addRect = new UnityEngine.Rect(rect.x + rect.width - 70, rect.y, 60, rect.height);

            if (UnityEngine.GUI.Button(addRect, "Add"))
            {
                AddGearItem(thingDef);
                FactionGearCustomizerMod.Settings.Write();
            }
        }

        private static string GetItemInfo(ThingDef thingDef)
        {
            List<string> infoParts = new List<string>();

            infoParts.Add(thingDef.techLevel.ToString());

            if (thingDef.IsWeapon)
            {
                float range = FactionGearManager.GetWeaponRange(thingDef);
                if (range > 0)
                {
                    infoParts.Add($"Range: {range}");
                }

                float damage = FactionGearManager.GetWeaponDamage(thingDef);
                if (damage > 0)
                {
                    infoParts.Add($"Damage: {damage}");
                }
            }

            string modSource = FactionGearManager.GetModSource(thingDef);
            if (!string.IsNullOrEmpty(modSource))
            {
                infoParts.Add(modSource);
            }

            return string.Join(" | ", infoParts);
        }

        private static void DrawFilters(UnityEngine.Rect rect)
        {
            var y = rect.y;
            var lineHeight = 20;

            var modLabelRect = new UnityEngine.Rect(rect.x, y, 80, lineHeight);
            UnityEngine.GUI.Label(modLabelRect, "Mod:");
            var modDropdownRect = new UnityEngine.Rect(rect.x + 80, y, rect.width - 80, lineHeight);
            var modSources = GetAllModSources();

            int modIndex = modSources.IndexOf(selectedModSource);
            if (modIndex < 0) modIndex = 0;
            int newModIndex = UnityEngine.GUI.Toolbar(modDropdownRect, modIndex, modSources.ToArray());
            selectedModSource = modSources[newModIndex];

            y += lineHeight + 5;

            var techLabelRect = new UnityEngine.Rect(rect.x, y, 80, lineHeight);
            UnityEngine.GUI.Label(techLabelRect, "Tech:");
            var techDropdownRect = new UnityEngine.Rect(rect.x + 80, y, rect.width - 80, lineHeight);

            var techLevels = new List<string> { "All" };
            techLevels.AddRange(Enum.GetNames(typeof(TechLevel)));
            int techIndex = selectedTechLevel.HasValue ? techLevels.IndexOf(selectedTechLevel.Value.ToString()) : 0;

            int newTechIndex = UnityEngine.GUI.Toolbar(techDropdownRect, techIndex, techLevels.ToArray());
            if (newTechIndex == 0)
                selectedTechLevel = null;
            else
                selectedTechLevel = (TechLevel)Enum.Parse(typeof(TechLevel), techLevels[newTechIndex]);

            y += lineHeight + 5;

            if (selectedCategory == GearCategory.Weapons)
            {
                var rangeLabelRect = new UnityEngine.Rect(rect.x, y, 80, lineHeight);
                UnityEngine.GUI.Label(rangeLabelRect, "Range:");
                var rangeSliderRect = new UnityEngine.Rect(rect.x + 80, y, rect.width - 80, lineHeight);
                minRange = UnityEngine.GUI.HorizontalSlider(rangeSliderRect, minRange, 0f, 50f);
                maxRange = UnityEngine.GUI.HorizontalSlider(new UnityEngine.Rect(rect.x + 80, y + 10, rect.width - 80, lineHeight), maxRange, 0f, 50f);

                var rangeValueRect = new UnityEngine.Rect(rect.x + 80, y + 20, rect.width - 80, lineHeight);
                // [修复] 错误位置：741行，错误内容：GUISkin未包含smallLabel的定义
                UnityEngine.GUI.Label(rangeValueRect, $"{minRange:F1} - {maxRange:F1}"); // 使用默认标签样式

                y += lineHeight * 3 + 5;
            }

            if (selectedCategory == GearCategory.Weapons || selectedCategory == GearCategory.MeleeWeapons)
            {
                var damageLabelRect = new UnityEngine.Rect(rect.x, y, 80, lineHeight);
                UnityEngine.GUI.Label(damageLabelRect, "Damage:");
                var damageSliderRect = new UnityEngine.Rect(rect.x + 80, y, rect.width - 80, lineHeight);
                minDamage = UnityEngine.GUI.HorizontalSlider(damageSliderRect, minDamage, 0f, 50f);
                maxDamage = UnityEngine.GUI.HorizontalSlider(new UnityEngine.Rect(rect.x + 80, y + 10, rect.width - 80, lineHeight), maxDamage, 0f, 50f);

                var damageValueRect = new UnityEngine.Rect(rect.x + 80, y + 20, rect.width - 80, lineHeight);
                // [修复] 错误位置：755行，错误内容：GUISkin未包含smallLabel的定义
                UnityEngine.GUI.Label(damageValueRect, $"{minDamage:F1} - {maxDamage:F1}"); // 使用默认标签样式

                y += lineHeight * 3 + 5;
            }
        }

        private static List<string> GetAllModSources()
        {
            var modSources = new HashSet<string> { "All" };
            foreach (var thingDef in DefDatabase<ThingDef>.AllDefs)
            {
                if (thingDef.modContentPack != null)
                {
                    modSources.Add(thingDef.modContentPack.Name);
                }
            }
            return modSources.OrderBy(s => s).ToList();
        }

        private static List<GearItem> GetCurrentCategoryGear(KindGearData kindData)
        {
            switch (selectedCategory)
            {
                case GearCategory.Weapons: return kindData.weapons;
                case GearCategory.MeleeWeapons: return kindData.meleeWeapons;
                case GearCategory.Armors: return kindData.armors;
                case GearCategory.Apparel: return kindData.apparel;
                case GearCategory.Accessories: return kindData.accessories;
                default: return new List<GearItem>();
            }
        }

        private static List<ThingDef> GetFilteredItems()
        {
            List<ThingDef> items = new List<ThingDef>();

            switch (selectedCategory)
            {
                case GearCategory.Weapons: items = FactionGearManager.GetAllWeapons(); break;
                case GearCategory.MeleeWeapons: items = FactionGearManager.GetAllMeleeWeapons(); break;
                case GearCategory.Armors: items = FactionGearManager.GetAllArmors(); break;
                case GearCategory.Apparel: items = FactionGearManager.GetAllApparel(); break;
                case GearCategory.Accessories: items = FactionGearManager.GetAllAccessories(); break;
            }

            items = ApplyFilters(items);

            if (!string.IsNullOrEmpty(searchText))
            {
                // [修复] 错误位置：804行，错误内容：TaggedString不包含Contains的定义
                items = items.Where(t => t.LabelCap.ToString().ToLower().Contains(searchText.ToLower())).ToList();
            }

            return items;
        }

        private static List<ThingDef> ApplyFilters(List<ThingDef> items)
        {
            return items.Where(item =>
                (selectedModSource == "All" || FactionGearManager.GetModSource(item) == selectedModSource) &&
                (!selectedTechLevel.HasValue || item.techLevel == selectedTechLevel.Value) &&
                (selectedCategory != GearCategory.Weapons ||
                 (FactionGearManager.GetWeaponRange(item) >= minRange && FactionGearManager.GetWeaponRange(item) <= maxRange)) &&
                ((selectedCategory != GearCategory.Weapons && selectedCategory != GearCategory.MeleeWeapons) ||
                 (FactionGearManager.GetWeaponDamage(item) >= minDamage && FactionGearManager.GetWeaponDamage(item) <= maxDamage))
            ).ToList();
        }

        private static void AddGearItem(ThingDef thingDef)
        {
            if (!string.IsNullOrEmpty(selectedFactionDefName) && !string.IsNullOrEmpty(selectedKindDefName))
            {
                var factionData = FactionGearCustomizerMod.Settings.GetOrCreateFactionData(selectedFactionDefName);
                var kindData = factionData.GetOrCreateKindData(selectedKindDefName);

                switch (selectedCategory)
                {
                    case GearCategory.Weapons:
                        if (!kindData.weapons.Any(g => g.thingDefName == thingDef.defName)) kindData.weapons.Add(new GearItem(thingDef.defName));
                        break;
                    case GearCategory.MeleeWeapons:
                        if (!kindData.meleeWeapons.Any(g => g.thingDefName == thingDef.defName)) kindData.meleeWeapons.Add(new GearItem(thingDef.defName));
                        break;
                    case GearCategory.Armors:
                        if (!kindData.armors.Any(g => g.thingDefName == thingDef.defName)) kindData.armors.Add(new GearItem(thingDef.defName));
                        break;
                    case GearCategory.Apparel:
                        if (!kindData.apparel.Any(g => g.thingDefName == thingDef.defName)) kindData.apparel.Add(new GearItem(thingDef.defName));
                        break;
                    case GearCategory.Accessories:
                        if (!kindData.accessories.Any(g => g.thingDefName == thingDef.defName)) kindData.accessories.Add(new GearItem(thingDef.defName));
                        break;
                }

                ValidateGearData(kindData);
            }
        }

        private static void ValidateGearData(KindGearData kindData)
        {
            RemoveInvalidGearItems(kindData.weapons);
            RemoveInvalidGearItems(kindData.meleeWeapons);
            RemoveInvalidGearItems(kindData.armors);
            RemoveInvalidGearItems(kindData.apparel);
            RemoveInvalidGearItems(kindData.accessories);

            ClampGearWeights(kindData.weapons);
            ClampGearWeights(kindData.meleeWeapons);
            ClampGearWeights(kindData.armors);
            ClampGearWeights(kindData.apparel);
            ClampGearWeights(kindData.accessories);
        }

        private static void RemoveInvalidGearItems(List<GearItem> gearItems)
        {
            for (int i = gearItems.Count - 1; i >= 0; i--)
            {
                if (gearItems[i].ThingDef == null)
                {
                    gearItems.RemoveAt(i);
                }
            }
        }

        private static void ClampGearWeights(List<GearItem> gearItems)
        {
            foreach (var gearItem in gearItems)
            {
                gearItem.weight = Mathf.Clamp(gearItem.weight, 0.1f, 10f);
            }
        }

        private static void RemoveGearItem(GearItem gearItem, KindGearData kindData)
        {
            switch (selectedCategory)
            {
                case GearCategory.Weapons: kindData.weapons.Remove(gearItem); break;
                case GearCategory.MeleeWeapons: kindData.meleeWeapons.Remove(gearItem); break;
                case GearCategory.Armors: kindData.armors.Remove(gearItem); break;
                case GearCategory.Apparel: kindData.apparel.Remove(gearItem); break;
                case GearCategory.Accessories: kindData.accessories.Remove(gearItem); break;
            }
        }

        // [修复] 修复了重置派系后派系变“裸体”的Bug，现在重置会重新抓取XML默认配置
        private static void ResetCurrentFaction()
        {
            if (!string.IsNullOrEmpty(selectedFactionDefName))
            {
                var factionData = FactionGearCustomizerMod.Settings.GetOrCreateFactionData(selectedFactionDefName);
                factionData.ResetToDefault();
                
                var factionDef = DefDatabase<FactionDef>.GetNamedSilentFail(selectedFactionDefName);
                if (factionDef != null && factionDef.pawnGroupMakers != null)
                {
                    foreach (var pawnGroupMaker in factionDef.pawnGroupMakers)
                    {
                        if (pawnGroupMaker.options != null)
                        {
                            foreach (var option in pawnGroupMaker.options)
                            {
                                // [修复] 错误位置：929行，错误内容：PawnGenOption未包含kindDef的定义
                                if (option.kind != null)
                                {
                                    var kindData = factionData.GetOrCreateKindData(option.kind.defName);
                                    FactionGearManager.LoadKindDefGear(option.kind, kindData);
                                }
                            }
                        }
                    }
                }
                FactionGearCustomizerMod.Settings.Write();
            }
        }

        // [修复] 同上，修复了单兵种重置的问题
        private static void ResetCurrentKind()
        {
            if (!string.IsNullOrEmpty(selectedFactionDefName) && !string.IsNullOrEmpty(selectedKindDefName))
            {
                var factionData = FactionGearCustomizerMod.Settings.GetOrCreateFactionData(selectedFactionDefName);
                var kindData = factionData.GetOrCreateKindData(selectedKindDefName);
                kindData.ResetToDefault();
                
                var kindDef = DefDatabase<PawnKindDef>.GetNamedSilentFail(selectedKindDefName);
                if (kindDef != null)
                {
                    FactionGearManager.LoadKindDefGear(kindDef, kindData);
                }

                FactionGearCustomizerMod.Settings.Write();
            }
        }

        private static void ResetFilters()
        {
            selectedModSource = "All";
            selectedTechLevel = null;
            minRange = 0f;
            maxRange = 100f;
            minDamage = 0f;
            maxDamage = 100f;
            searchText = "";
        }

        private static void DrawCategoryTabs(UnityEngine.Rect rect)
        {
            var tabWidth = (rect.width - 8) / 5;

            for (int i = 0; i < 5; i++)
            {
                var tabRect = new UnityEngine.Rect(rect.x + i * (tabWidth + 2), rect.y, tabWidth, rect.height);

                GearCategory category = (GearCategory)i;
                string label = GetCategoryLabel(category);

                if (UnityEngine.GUI.Button(tabRect, label))
                {
                    selectedCategory = category;
                }

                if (selectedCategory == category)
                {
                    UnityEngine.GUI.color = new UnityEngine.Color(0.7f, 0.7f, 0.7f, 0.5f);
                    UnityEngine.GUI.DrawTexture(tabRect, UnityEngine.Texture2D.whiteTexture);
                    UnityEngine.GUI.color = UnityEngine.Color.white;
                }
            }
        }

        private static string GetCategoryLabel(GearCategory category)
        {
            switch (category)
            {
                case GearCategory.Weapons: return "Weapons";
                case GearCategory.MeleeWeapons: return "Melee";
                case GearCategory.Armors: return "Armor";
                case GearCategory.Apparel: return "Apparel";
                case GearCategory.Accessories: return "Accessories";
                default: return "Unknown";
            }
        }
    }

    public enum GearCategory
    {
        Weapons,
        MeleeWeapons,
        Armors,
        Apparel,
        Accessories
    }
}