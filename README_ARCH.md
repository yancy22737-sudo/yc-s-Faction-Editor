# FactionGearModification 模块架构文档

## 一、整体架构概述

本项目采用**分层架构**（Layered Architecture）设计，将代码划分为多个职责分明的模块，以实现**低耦合、高内聚**的目标。整个模组分为以下六个主要层次：

```
┌─────────────────────────────────────────────┐
│              UI Layer (表现层)               │
│   负责用户界面绘制、交互响应、状态展示        │
├─────────────────────────────────────────────┤
│           Managers Layer (业务层)            │
│   负责核心业务逻辑、数据处理、功能协调        │
├─────────────────────────────────────────────┤
│             Data Layer (数据层)              │
│   定义数据结构、枚举、业务实体                │
├─────────────────────────────────────────────┤
│              IO Layer (数据持久化)           │
│   负责预设的读取与保存                        │
├─────────────────────────────────────────────┤
│           Patches Layer (补丁层)             │
│   通过Harmony补丁修改游戏原生行为            │
├─────────────────────────────────────────────┤
│             Core Layer (核心层)              │
│   模组入口、配置管理、全局状态                │
└─────────────────────────────────────────────┘
```

---

## 二、模块详细说明

### 2.1 Core Layer（核心层）

**职责**：模组的启动入口、全局配置管理、版本控制。

| 文件 | 职责描述 |
|------|----------|
| `FactionGearCustomizerMod.cs` | Mod主入口类，继承自RimWorld的`Mod`，负责初始化Harmony补丁、加载设置、渲染设置界面 |
| `FactionGearCustomizerSettings.cs` | 设置类，继承自`ModSettings`，负责所有配置的序列化与反序列化 |
| `MainButtonWorker_FactionGear.cs` | 主按钮工作器，决定侧边栏按钮的显示与点击行为 |
| `ModVersion.cs` | 版本号管理，提供当前模组版本的读取接口 |
| `Startup.cs` | 启动逻辑，处理模组首次加载时的初始化工作 |

---

### 2.2 Data Layer（数据模型层）

**职责**：定义业务所需的所有数据结构、枚举类型和实体类。

| 文件 | 职责描述 |
|------|----------|
| `Enums.cs` | 定义所有枚举类型，包括：`GearCategory`（装备分类）、`EditorMode`（编辑模式）、`AdvancedTab`（高级标签页）等 |
| `FactionGearData.cs` | 阵营装备数据类，存储单个阵营的兵种装备配置，含字典索引优化查询效率 |
| `FactionGearPreset.cs` | 预设数据类，封装完整配置的保存/加载逻辑 |
| `GearItem.cs` | 装备物品类，表示一个可穿戴或使用的物品，含权重（weight）属性 |
| `KindGearData.cs` | 兵种装备数据类，存储单个兵种（PawnKindDef）的所有装备配置 |
| `SpecRequirementEdit.cs` | 高级需求编辑类，用于精确指定特定物品、材质、品质等 |
| `ForcedHediff.cs` | 强制健康状态类，定义兵种必须携带的健康状态（如Scaria） |

---

### 2.3 Managers Layer（业务逻辑层）

**职责**：实现核心业务逻辑，处理数据存取与业务计算。

| 文件 | 职责描述 |
|------|----------|
| `FactionGearManager.cs` | **核心管理器**，负责：从DefDatabase加载装备数据、计算武器DPS/射程/伤害、获取护甲评级、管理装备分类缓存（静态缓存提升性能）、提供Mod来源分组成员功能 |
| `GearApplier.cs` | 装备应用器，负责将配置应用到游戏中的Pawn，生成实际的装备 |
| `UndoManager.cs` | 撤销管理器，记录并恢复兵种装备数据的修改历史，支持撤销/重做功能 |
| `FactionSpawnManager.cs` | 派系生成与殖民地管理，负责派系实例生成、世界地图定居点生成、瓦片查找验证、WorldTargeter目标选择等功能 |

---

### 2.4 IO Layer（数据持久化层）

**职责**：处理预设的外部存储与读取。

| 文件 | 职责描述 |
|------|----------|
| `PresetIOManager.cs` | 预设IO管理器，负责将预设数据写入文件系统或从文件系统读取 |

---

### 2.5 UI Layer（表现层）

**职责**：负责所有用户界面的绘制与交互响应。采用**面板化设计**，将复杂界面拆分为独立组件。

#### 2.5.1 UI 目录结构

```
UI/
├── Dialogs/                   # 专用对话框（局部功能弹窗）
│   ├── Dialog_ConfirmDeleteGroup.cs  # 删除群组确认弹窗
│   └── Dialog_PawnGroupGenerationPreview.cs # 派系群组生成预览弹窗（懒加载Pawn肖像）
├── Panels/                    # 可复用的UI面板组件
│   ├── FactionListPanel.cs   # 阵营列表面板
│   ├── KindListPanel.cs      # 兵种列表面板
│   ├── GearEditPanel.cs      # 装备编辑面板（Simple/Advanced模式）
│   └── ItemLibraryPanel.cs   # 物品库面板（筛选、排序、搜索）
├── Pickers/                   # 可复用的选择器/筛选器组件
│   └── ThingPickerFilterBar.cs # ThingDef 选择器筛选条（搜索/Mod/Tech/排序/范围）
├── State/                    # UI状态管理
│   ├── EditorSession.cs      # 编辑器会话状态（静态类，存储当前选中的阵营/兵种/筛选条件等）
│   └── PickerSession.cs      # 选择器会话状态（静态类，记忆各新增界面筛选条件）
├── Dialog_ConfirmWithCheckbox.cs  # 带复选框的确认对话框
├── Dialog_ApparelPicker.cs   # 服装新增/选择弹窗（带筛选器）
├── Dialog_HediffPicker.cs    # 状态新增/选择弹窗（带筛选器）
├── FactionDetailWindow.cs    # 阵营详情弹窗
├── FactionGearEditor.cs     # 编辑器主控制器（协调各面板布局）
├── FactionGearMainTabWindow.cs  # 主Tab窗口（已废弃，保留兼容性）
├── FactionGearSettingsWindow.cs # 新版设置窗口（标准弹窗模式）
├── FactionGearPreviewWindow.cs  # 装备预览窗口（游戏内生成Pawn预览）
├── PresetManagerWindow.cs    # 预设管理窗口
├── TexCache.cs              # 纹理缓存（图标缓存优化性能）
├── Window_ColorPicker.cs    # 颜色选择器弹窗
├── Window_ModFilter.cs      # Mod筛选器弹窗
├── Dialog_WeaponPicker.cs    # 武器新增/选择弹窗（带筛选器）
└── WidgetsUtils.cs          # UI工具类，封装DrawTextureFitted等兼容性方法（集成智能反射兼容1.6）
```

补充约定：
- UI 窗口可能在主菜单/设置界面中打开（非 Playing 状态），此时不应调用 `Verse.Messages.Message`，应使用弹窗或日志作为提示渠道（例如 PresetManagerWindow 的 Notify 策略）。

#### 2.5.2 面板职责说明

| 面板 | 职责描述 |
|------|----------|
| `FactionListPanel` | 显示所有可选阵营（人类阵营），支持搜索过滤 |
| `KindListPanel` | 显示选中阵营下的所有兵种（PawnKindDef）列表 |
| `GearEditPanel` | **核心编辑面板**，支持Simple模式（标签页切换、批量编辑）和Advanced模式（精确控制），提供撤销/重做、预览、清除等功能 |
| `ItemLibraryPanel` | 物品库浏览面板，提供多维度筛选（Mod来源、科技等级、价格区间、武器射程/伤害等）和排序功能 |

#### 2.5.3 状态管理

- `EditorSession`：静态类，作为全局状态容器，存储当前选中的阵营/兵种、当前编辑模式、筛选条件、滚动位置等，避免组件间频繁传递状态。

---

### 2.6 Patches Layer（补丁层）

**职责**：通过Harmony库修改游戏原生行为，实现自定义装备生成。

| 文件 | 职责描述 |
|------|----------|
| `Patch_GeneratePawn.cs` | 补丁文件，拦截游戏生成Pawn的逻辑，在生成装备前应用本模组的自定义配置 |
| `Patch_FloatMenuMakerWorld.cs` | 补丁文件，拦截世界地图右键菜单生成逻辑，添加派系殖民地生成选项 |

---

### 2.7 Properties Layer（属性文件）

| 文件 | 职责描述 |
|------|----------|
| `VersionInfo.cs` | 程序集版本信息（AutoGenerated） |

---

## 三、模块依赖关系图

```
Core (启动入口)
  │
  ├─► Settings ────────► Data (配置序列化)
  │                       │
  │                       │
  │                       ▼
  │                 Managers (业务逻辑)
  │                       │
  │                       ├─► IO (预设读写)
  │                       │
  │                       ▼
  │                 UI (表现层)
  │                       │
  │                       ▼
  │                 Patches (补丁注入)
  │
  └─► Patches (补丁初始化)
```

---

## 四、设计原则与实践

1. **模块化**：UI拆分为独立面板组件，降低单文件复杂度
2. **低耦合**：UI表现层与业务逻辑层分离，业务逻辑集中在Managers层
3. **状态外置**：编辑器状态存储在EditorSession静态类，UI组件无状态
4. **性能优化**：
   - 使用静态缓存（`cachedAllWeapons`等）避免重复遍历DefDatabase
   - 图标缓存（`iconCache`）减少纹理加载开销
   - 字典索引（`kindGearDataDict`）加速数据查询
5. **可维护性**：清晰的层次结构和命名规范，提高代码可读性
6. **项目DLC功能与本体环境完全兼容**：
    - 所有DLC相关功能均已正确使用 ModsConfig.*Active 进行条件保护，不会在本体不含DLC的测试环境中引发错误或异常。
    - 数据持久化层也采用了安全的字符串引用方式，确保跨环境存档兼容性。
  