# Faction Gear Modification (派系装备自定义器)

**Faction Gear Modification** 是一个功能强大的 RimWorld 模组，允许玩家在游戏内实时、深度地自定义各个派系（Faction）下具体兵种（PawnKind）的装备配置。无论是想要统一帝国军队的制服，还是给海盗增加致命的生化义体，本模组都能轻松实现。

## ✨ 核心功能

### 1. 双模式编辑
模组提供两种编辑模式，满足不同层次的自定义需求：

*   **简单模式 (Simple Mode)**
    *   **快速配置**：通过勾选列表快速指定兵种可用的武器、头盔、护甲和衣物池。
    *   **权重控制**：为每个物品类别设置生成权重，系统将根据权重随机选择装备。
    *   **预算限制**：自动遵循原版或自定义的预算限制，防止生成过于昂贵的装备。

*   **高级模式 (Advanced Mode)**
    *   **精细化控制**：不再局限于随机池，你可以指定具体的物品。
    *   **属性定制**：
        *   **材质 (Material)**：强制指定装备材质（如：玻璃钢、魔鬼素）。
        *   **品质 (Quality)**：设定装备品质范围（如：极佳 ~ 传奇）。
        *   **颜色 (Color)**：自定义装备颜色，打造统一的派系视觉风格。
        *   **样式 (Style)**：支持 Ideology DLC 的样式覆盖。
    *   **选择逻辑**：支持多种生成逻辑，如 `AlwaysTake`（必带）、`RandomChance`（概率携带）、`FromPool`（从指定池中随机选择）。

### 2. 全方位定制
不仅限于武器和服装，本模组还支持对生物特性的深度修改：

*   **健康状态 (Hediff)**：强制给生成的单位添加特定的健康状态，如仿生肢体、植入物、疾病或成瘾品依赖。
*   **基因 (Gene)**：(Biotech DLC) 为特定兵种强制赋予或移除特定基因，创造独特的亚人种族军队。

### 3. 现代化管理体验
*   **实时预览**：内置 Pawn 预览窗口，所见即所得，实时查看修改后的兵种外观。
*   **预设系统**：支持将配置保存为预设 (Preset)，方便在不同存档间共享或快速应用。
*   **撤销/重做**：内置操作历史记录，防止误操作。
*   **复制/粘贴**：支持在不同兵种间快速复制配置。

---

## 🔧 游戏机制详解 (Game Mechanics)

### 1. 拦截与生成 (Hooking Generation)
本模组使用 **Harmony** 库对原版的 `PawnGenerator.GeneratePawn` 方法进行了 **Postfix**（后置）拦截。
*   **执行时机**：当游戏生成一个 Humanlike（人类）Pawn 完毕后，模组的逻辑立即介入。
*   **覆盖原版**：模组会根据配置，清理原版生成的装备，并应用你的自定义配置。这意味着你可以完全接管装备生成权。

### 2. 装备应用流程 (Gear Application Flow)
当一个受监控的 Pawn 生成时，`GearApplier` 会按以下顺序执行操作：

1.  **清理阶段**：
    *   如果启用了 `ForceNaked`（强制裸体）或 `ForceOnlySelected`（仅限选中），系统会先剥离 Pawn 身上已有的所有装备，确保不会出现原版装备混搭的情况。

2.  **武器生成**：
    *   **优先级**：优先检查高级模式配置 (`SpecificWeapons`)。如果为空，则回退到简单模式的随机池。
    *   **属性应用**：根据配置生成具体材质、品质的武器。
    *   **生物编码**：支持设置武器被生物编码 (Biocoded) 的概率。

3.  **服装生成**：
    *   **预算检查**：系统会根据 `ApparelMoney` 预算限制来生成服装。如果开启 `ForceIgnore`，则忽略预算限制，强制穿戴所有指定装备。
    *   **冲突检测**：在穿戴每件装备前，系统调用 `ApparelUtility.HasPartsToWear` 检查身体部位是否已被占用，防止穿模或逻辑冲突（如无法同时穿戴两件防弹背心）。
    *   **层级覆盖**：支持按头饰、外衣、内衣、配件等层级分别配置。

4.  **Hediff 与基因**：
    *   最后应用健康状态和基因修改。Hediff 的添加经过精心处理，确保安装在正确的身体部位（如仿生腿安装在腿部）。

---

## 📖 使用指南

### 如何开始
1.  进入游戏，打开 **选项 (Options)** -> **Mod 设置 (Mod Settings)**。
2.  找到 **Faction Gear Customizer** 并点击 **打开编辑器 (Open Editor)**。
3.  在左侧选择目标 **派系 (Faction)**，中间选择 **兵种 (PawnKind)**。

### 简单模式 vs 高级模式
*   **切换方式**：在兵种配置面板顶部，点击 `Simple / Advanced` 按钮切换。
*   **简单模式**：适合快速调整。勾选你希望该兵种使用的武器和服装类别，调整下方的总预算条即可。
*   **高级模式**：点击列表中的 `Add` 按钮添加具体条目。点击条目右侧的 `Edit` 图标可以进入详细配置面板，设置材质、颜色和生成概率。

### 预设管理
*   **保存预设**：配置满意后，点击顶部的 `Preset` -> `Save Preset`。
*   **加载预设**：点击 `Load Preset` 可以将之前的配置应用到当前兵种。
*   **导入/导出**：预设文件以 XML 格式存储，支持分享给其他玩家。

---

## ❓ 常见问题 (FAQ)

**Q: 这个 Mod 会影响现有的 Pawn 吗？**
A: **不会**。修改仅对 **新生成** 的 Pawn 生效（如新刷新的袭击、商队、援军）。地图上已经存在的单位不会发生变化。

**Q: 兼容 Combat Extended (CE) 吗？**
A: **理论兼容**。模组主要负责生成装备，而具体的战斗逻辑由 CE 接管。只要你配置的武器和弹药在 CE 中是合法的，通常不会有问题。

**Q: 为什么有些装备穿不上？**
A: 请检查：
1.  **预算限制**：如果未开启 `ForceIgnore`，且装备总价值超过了兵种的 `ApparelMoney`，系统会跳过部分装备。
2.  **部位冲突**：如果兵种已经穿了一件占用相同身体部位（如 Torso）的装备，后续装备将无法穿戴。
3.  **种族限制**：某些异种人或外星种族可能无法穿戴特定的人类服装。

**Q: 支持其他 Mod 的装备吗？**
A: **完美支持**。模组会自动读取所有已加载 Mod 中的武器、服装、Hediff 和基因。

---

## 🛠️ 安装与依赖

1.  **前置需求**：
    *   **Harmony**
    *   **RimWorld Core**

2.  **安装步骤**：
    *   订阅 Steam 创意工坊页面。
    *   在游戏启动器的 Mod 列表中激活 **Faction Gear Modification**。
    *   确保排序在 Core 和 Harmony 之后。

---

## 🤝 贡献与反馈
如果你发现了 Bug 或有改进建议，欢迎在 Steam 创意工坊评论区或 GitHub Issues 中反馈。

**Credits:**
Created by yancy. Inspired by "Total Control".
